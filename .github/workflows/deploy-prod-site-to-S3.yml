name: Deploy Prod Static Site to S3

on:
  push:
    branches: [main]
  workflow_dispatch:  # Allow manual triggers

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Add Version Metadata to HTML
        run: |
          echo "ğŸ“¦ Adding version metadata to HTML files..."
          
          COMMIT_SHA="${{ github.sha }}"
          COMMIT_SHORT="${COMMIT_SHA:0:7}"
          BUILD_TIME=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
          BUILD_NUMBER="${{ github.run_number }}"
          
          # Find all HTML files and add version meta tags
          find ./theprojectfolder/cloudresumechallenge/site -name "*.html" -type f | while IFS= read -r file; do
            # Check if meta tags already exist
            if grep -q 'name="version"' "$file"; then
              echo "  Updating version in: $file"
              # Update existing meta tags
              sed -i "s|<meta name=\"version\" content=\"[^\"]*\">|<meta name=\"version\" content=\"$COMMIT_SHORT\">|" "$file"
              sed -i "s|<meta name=\"build-time\" content=\"[^\"]*\">|<meta name=\"build-time\" content=\"$BUILD_TIME\">|" "$file"
              sed -i "s|<meta name=\"build-number\" content=\"[^\"]*\">|<meta name=\"build-number\" content=\"$BUILD_NUMBER\">|" "$file"
            else
              echo "  Adding version to: $file"
              # Add new meta tags before </head>
              sed -i "s|</head>|  <meta name=\"version\" content=\"$COMMIT_SHORT\">\n  <meta name=\"build-time\" content=\"$BUILD_TIME\">\n  <meta name=\"build-number\" content=\"$BUILD_NUMBER\">\n</head>|" "$file"
            fi
          done
          
          echo "âœ… Version metadata added successfully"
          echo "   Version: $COMMIT_SHORT"
          echo "   Build Time: $BUILD_TIME"
          echo "   Build Number: $BUILD_NUMBER"

      - name: Configure AWS Credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::102587257710:role/GitHubActionsProdRole
          aws-region: us-east-1

      - name: Verify AWS Identity
        run: aws sts get-caller-identity

      - name: Pre-Deployment Validation
        run: |
<<<<<<< HEAD
          echo "ğŸ” Validating deployment requirements..."
          
          # Check if site folder exists and has content
          if [ ! -d "./theprojectfolder/cloudresumechallenge/site" ]; then
            echo "âŒ ERROR: site/ directory does not exist"
=======
          if [ -z "$(ls -A ./theprojectfolder/cloudresumechallenge/site)" ]; then
            echo "Local folder is empty. Aborting sync to prevent deletion."
>>>>>>> dev
            exit 1
          fi
          
          if [ -z "$(ls -A ./theprojectfolder/cloudresumechallenge/site)" ]; then
            echo "âŒ ERROR: site/ folder is empty. Aborting to prevent deletion."
            exit 1
          fi
          
          # Check for index.html (critical file)
          if [ ! -f "./theprojectfolder/cloudresumechallenge/site/index.html" ]; then
            echo "âš ï¸  WARNING: index.html not found. Deployment may fail."
          fi
          
          echo "âœ… Pre-deployment validation passed"

      - name: Dry Run Sync Preview
        run: |
<<<<<<< HEAD
          echo "ğŸ“‹ Preview of changes that will be synced to PRODUCTION:"
          aws s3 sync ./theprojectfolder/cloudresumechallenge/site/ s3://www.theprojectfolder.com \
            --dryrun
=======
          aws s3 sync ./theprojectfolder/cloudresumechallenge/site/ s3://www.theprojectfolder.com \
            --exclude "*.pdf" \
            --dryrun
        
      - name: Deploy Website (Safe Upload)
        run: |
          aws s3 sync ./theprojectfolder/cloudresumechallenge/site/ s3://www.theprojectfolder.com \
            --exclude "*.pdf"
      
>>>>>>> dev

      # Deploy HTML files with short cache
      - name: Deploy HTML Files
        run: |
<<<<<<< HEAD
          echo "ğŸ“„ Deploying HTML files..."
          aws s3 sync ./theprojectfolder/cloudresumechallenge/site/ s3://www.theprojectfolder.com \
            --exclude "*" \
            --include "*.html" \
            --content-type "text/html; charset=utf-8" \
            --cache-control "public, max-age=300, must-revalidate" \
            --metadata-directive REPLACE

      # Deploy CSS/JS with long cache
      - name: Deploy CSS Files
        run: |
          echo "ğŸ¨ Deploying CSS files..."
          aws s3 sync ./theprojectfolder/cloudresumechallenge/site/ s3://www.theprojectfolder.com \
            --exclude "*" \
            --include "*.css" \
            --content-type "text/css" \
            --cache-control "public, max-age=31536000, immutable"

      - name: Deploy JavaScript Files
        run: |
          echo "âš¡ Deploying JavaScript files..."
          cd ./theprojectfolder/cloudresumechallenge/site
          find . -name "*.js" -type f | while read file; do
            key="${file#./}"
            aws s3 cp "$file" "s3://www.theprojectfolder.com/$key" \
              --content-type "application/javascript" \
              --cache-control "public, max-age=31536000, immutable"
          done

      # Deploy images with long cache
      - name: Deploy Images
        run: |
          echo "ğŸ–¼ï¸  Deploying images..."
          aws s3 sync ./theprojectfolder/cloudresumechallenge/site/ s3://www.theprojectfolder.com \
            --exclude "*" \
            --include "*.jpg" \
            --include "*.jpeg" \
            --include "*.png" \
            --include "*.gif" \
            --include "*.svg" \
            --include "*.webp" \
            --include "*.ico" \
            --cache-control "public, max-age=31536000, immutable"

      # Deploy fonts with long cache
      - name: Deploy Fonts
        run: |
          echo "ğŸ”¤ Deploying fonts..."
          aws s3 sync ./theprojectfolder/cloudresumechallenge/site/ s3://www.theprojectfolder.com \
            --exclude "*" \
            --include "*.woff" \
            --include "*.woff2" \
            --include "*.ttf" \
            --include "*.eot" \
            --cache-control "public, max-age=31536000, immutable"

      # Deploy PDFs with moderate cache
      - name: Deploy PDF Files
        run: |
          cd ./theprojectfolder/cloudresumechallenge/site
          pdf_count=$(find . -name "*.pdf" -type f | wc -l)
          
          if [ "$pdf_count" -eq 0 ]; then
            echo "â„¹ï¸  No PDF files found. Skipping upload."
            exit 0
          fi
=======
          pdfs=$(find "./theprojectfolder/cloudresumechallenge/site/assets" -name "*.pdf")
          if [ -z "$pdfs" ]; then
            echo "No PDF files found. Skipping upload."
            exit 0
          fi
      
          echo "$pdfs" | while IFS= read -r file; do
            echo "Uploading: $file"
            key="${file#./theprojectfolder/cloudresumechallenge/site/assets/}"
            aws s3 cp "$file" "s3://www.theprojectfolder.com/assets/$key" \
              --content-type application/pdf \
              --cache-control "no-cache, no-store, must-revalidate"
          done
>>>>>>> dev
          
          echo "ğŸ“„ Uploading $pdf_count PDF file(s)..."
          find . -name "*.pdf" -type f | while IFS= read -r file; do
            echo "  Uploading: $file"
            aws s3 cp "$file" "s3://www.theprojectfolder.com/${file#./}" \
              --content-type "application/pdf" \
              --cache-control "public, max-age=3600, must-revalidate"
          done

      # Catch any remaining files
      - name: Deploy Other Files
        run: |
          echo "ğŸ“¦ Deploying remaining files..."
          aws s3 sync ./theprojectfolder/cloudresumechallenge/site/ s3://www.theprojectfolder.com \
            --exclude "*.html" \
            --exclude "*.css" \
            --exclude "*.js" \
            --exclude "*.jpg" \
            --exclude "*.jpeg" \
            --exclude "*.png" \
            --exclude "*.gif" \
            --exclude "*.svg" \
            --exclude "*.webp" \
            --exclude "*.ico" \
            --exclude "*.woff*" \
            --exclude "*.ttf" \
            --exclude "*.eot" \
            --exclude "*.pdf"

      # Invalidate both CloudFront distributions
      - name: Invalidate CloudFront Caches
        run: |
          echo "ğŸ”„ Invalidating CloudFront caches..."
          
          # WWW distribution
          echo "  Invalidating www.theprojectfolder.com (E2UA1URROHIZXT)..."
          aws cloudfront create-invalidation \
            --distribution-id E2UA1URROHIZXT \
            --paths "/*" \
            --no-cli-pager
          
          # Apex domain distribution
          echo "  Invalidating theprojectfolder.com (E2YXOTOZ4EWSMK)..."
          aws cloudfront create-invalidation \
            --distribution-id E2YXOTOZ4EWSMK \
            --paths "/*" \
            --no-cli-pager
          
          echo "âœ… CloudFront invalidations initiated"
          echo "â±ï¸  Note: Invalidations typically take 1-3 minutes to complete"

      - name: Verify Production Deployment
        run: |
          echo "ğŸ” Verifying production deployment..."
          sleep 10  # Wait for S3 propagation
          
          # Test WWW domain
          www_response=$(curl -s -o /dev/null -w "%{http_code}" https://www.theprojectfolder.com/index.html || echo "000")
          
          # Test apex domain
          apex_response=$(curl -s -o /dev/null -w "%{http_code}" https://theprojectfolder.com/index.html || echo "000")
          
          echo "Results:"
          echo "  www.theprojectfolder.com: HTTP $www_response"
          echo "  theprojectfolder.com: HTTP $apex_response"
          
          if [ "$www_response" = "200" ] && [ "$apex_response" = "200" ]; then
            echo "âœ… Production deployment verified successfully"
          else
            echo "âš ï¸  Warning: Some domains returned non-200 status"
            echo "This might be normal immediately after deployment due to CloudFront caching"
          fi

      - name: Deployment Summary
        run: |
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸš€ PRODUCTION DEPLOYMENT COMPLETE"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "Environment:    PRODUCTION"
          echo "S3 Bucket:      s3://www.theprojectfolder.com"
          echo "Primary URL:    https://www.theprojectfolder.com"
          echo "Apex URL:       https://theprojectfolder.com"
          echo "Branch:         ${{ github.ref_name }}"
          echo "Commit:         ${{ github.sha }}"
          echo "Triggered by:   ${{ github.actor }}"
          echo ""
          echo "CloudFront distributions invalidated:"
          echo "  â€¢ E2UA1URROHIZXT (www)"
          echo "  â€¢ E2YXOTOZ4EWSMK (apex)"
          echo ""
          echo "â±ï¸  Allow 1-3 minutes for CloudFront propagation"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"