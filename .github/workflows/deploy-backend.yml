name: Deploy Backend to AWS

on:
  push:
    branches: [main]
    paths:
      - 'backend/**'
      - '.github/workflows/deploy-backend.yml'
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r backend/tests/requirements.txt
          pip install boto3

      - name: Run Unit Tests
        run: |
          cd backend
          pytest tests/ -v --cov=lambda --cov-report=term-missing

      - name: Test Summary
        if: always()
        run: |
          echo "âœ… All tests passed successfully"

  deploy:
    needs: test
    runs-on: ubuntu-latest
    
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Configure AWS Credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::102587257710:role/GitHubActionsBackendRole
          aws-region: us-east-1

      - name: Verify AWS Identity
        run: aws sts get-caller-identity

      - name: Package Lambda Function
        run: |
          echo "ğŸ“¦ Packaging Lambda function..."
          cd backend/lambda
          zip -r ../function.zip visitor_counter.py
          cd ..
          ls -lh function.zip

      - name: Deploy CloudFormation Stack
        run: |
          echo "ğŸš€ Deploying backend CloudFormation stack..."
          
          aws cloudformation deploy \
            --template-file backend/infrastructure/backend_stack.yaml \
            --stack-name CloudResumeChallengeBackend-prod \
            --parameter-overrides \
              AllowedOrigin=https://www.theprojectfolder.com \
              Environment=prod \
            --capabilities CAPABILITY_NAMED_IAM \
            --no-fail-on-empty-changeset

      - name: Update Lambda Function Code
        run: |
          echo "ğŸ“¤ Updating Lambda function code..."
          
          FUNCTION_NAME=$(aws cloudformation describe-stacks \
            --stack-name CloudResumeChallengeBackend-prod \
            --query 'Stacks[0].Outputs[?OutputKey==`LambdaFunctionArn`].OutputValue' \
            --output text | cut -d: -f7)
          
          aws lambda update-function-code \
            --function-name $FUNCTION_NAME \
            --zip-file fileb://backend/function.zip \
            --no-cli-pager

      - name: Wait for Lambda Update
        run: |
          echo "â³ Waiting for Lambda function to be ready..."
          
          FUNCTION_NAME=$(aws cloudformation describe-stacks \
            --stack-name CloudResumeChallengeBackend-prod \
            --query 'Stacks[0].Outputs[?OutputKey==`LambdaFunctionArn`].OutputValue' \
            --output text | cut -d: -f7)
          
          aws lambda wait function-updated-v2 --function-name $FUNCTION_NAME

      - name: Get Function URL
        run: |
          echo "ğŸ”— Retrieving Lambda Function URL..."
          
          FUNCTION_URL=$(aws cloudformation describe-stacks \
            --stack-name CloudResumeChallengeBackend-prod \
            --query 'Stacks[0].Outputs[?OutputKey==`FunctionUrl`].OutputValue' \
            --output text)
          
          echo "Function URL: $FUNCTION_URL"

      - name: Test Deployed Function
        run: |
          echo "ğŸ§ª Testing deployed Lambda function..."
          
          FUNCTION_URL=$(aws cloudformation describe-stacks \
            --stack-name CloudResumeChallengeBackend-prod \
            --query 'Stacks[0].Outputs[?OutputKey==`FunctionUrl`].OutputValue' \
            --output text)
          
          # Test GET request
          echo "Testing GET request..."
          response=$(curl -s -X GET "$FUNCTION_URL")
          echo "Response: $response"
          
          if echo "$response" | grep -q "visitorCount"; then
            echo "âœ… GET request successful"
          else
            echo "âŒ GET request failed"
            exit 1
          fi
          
          # Test POST request
          echo "Testing POST request..."
          response=$(curl -s -X POST "$FUNCTION_URL")
          echo "Response: $response"
          
          if echo "$response" | grep -q "visitorCount"; then
            echo "âœ… POST request successful"
          else
            echo "âŒ POST request failed"
            exit 1
          fi

      - name: Deployment Summary
        run: |
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸš€ BACKEND DEPLOYMENT COMPLETE"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "Stack Name:     CloudResumeChallengeBackend-prod"
          echo "Environment:    Production"
          echo "Branch:         ${{ github.ref_name }}"
          echo "Commit:         ${{ github.sha }}"
          echo ""
          
          FUNCTION_URL=$(aws cloudformation describe-stacks \
            --stack-name CloudResumeChallengeBackend-prod \
            --query 'Stacks[0].Outputs[?OutputKey==`FunctionUrl`].OutputValue' \
            --output text)
          
          TABLE_NAME=$(aws cloudformation describe-stacks \
            --stack-name CloudResumeChallengeBackend-prod \
            --query 'Stacks[0].Outputs[?OutputKey==`DynamoDBTableName`].OutputValue' \
            --output text)
          
          echo "Function URL:   $FUNCTION_URL"
          echo "DynamoDB Table: $TABLE_NAME"
          echo ""
          echo "âœ… Tests passed"
          echo "âœ… Stack deployed"
          echo "âœ… Function updated"
          echo "âœ… Live tests successful"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"