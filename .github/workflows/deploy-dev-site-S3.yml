name: Deploy Dev Static Site to S3

on:
  push:
    branches: [dev]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Configure AWS Credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::102587257710:role/GitHubActionsDevRole
          aws-region: us-east-1

      - name: Debug AWS Identity
        run: aws sts get-caller-identity

      - name: Pre-Sync Safety Check
        run: |
          if [ -z "$(ls -A ./theprojectfolder/cloudresumechallenge/dev-site)" ]; then
            echo "‚ùå Local dev-site folder is empty. Aborting sync to prevent deletion."
            exit 1
          fi
          echo "‚úÖ Local dev-site folder contains files"

      - name: Dry Run Sync Preview
        run: |
          echo "üìã Preview of changes that will be synced:"
          aws s3 sync ./theprojectfolder/cloudresumechallenge/dev-site/ s3://dev.theprojectfolder.com \
            --dryrun

      # Deploy HTML files with short cache
      - name: Deploy HTML Files
        run: |
          aws s3 sync ./theprojectfolder/cloudresumechallenge/dev-site/ s3://dev.theprojectfolder.com \
            --exclude "*" \
            --include "*.html" \
            --content-type "text/html; charset=utf-8" \
            --cache-control "public, max-age=300, must-revalidate" \
            --metadata-directive REPLACE

      # Deploy CSS/JS with long cache (assumes you use versioned filenames)
      - name: Deploy CSS and JavaScript
        run: |
          aws s3 sync ./theprojectfolder/cloudresumechallenge/dev-site/ s3://dev.theprojectfolder.com \
            --exclude "*" \
            --include "*.css" \
            --include "*.js" \
            --content-type "text/css" \
            --cache-control "public, max-age=31536000, immutable"
          
          # Set correct content-type for JS files separately
          find ./theprojectfolder/cloudresumechallenge/dev-site -name "*.js" -type f | while read file; do
            key="${file#./theprojectfolder/cloudresumechallenge/dev-site/}"
            aws s3 cp "$file" "s3://dev.theprojectfolder.com/$key" \
              --content-type "application/javascript" \
              --cache-control "public, max-age=31536000, immutable"
          done

      # Deploy images with long cache
      - name: Deploy Images
        run: |
          aws s3 sync ./theprojectfolder/cloudresumechallenge/dev-site/ s3://dev.theprojectfolder.com \
            --exclude "*" \
            --include "*.jpg" \
            --include "*.jpeg" \
            --include "*.png" \
            --include "*.gif" \
            --include "*.svg" \
            --include "*.webp" \
            --include "*.ico" \
            --cache-control "public, max-age=31536000, immutable"

      # Deploy fonts with long cache
      - name: Deploy Fonts
        run: |
          aws s3 sync ./theprojectfolder/cloudresumechallenge/dev-site/ s3://dev.theprojectfolder.com \
            --exclude "*" \
            --include "*.woff" \
            --include "*.woff2" \
            --include "*.ttf" \
            --include "*.eot" \
            --cache-control "public, max-age=31536000, immutable"

      # Deploy PDFs with moderate cache
      - name: Deploy PDF Files
        run: |
          cd ./theprojectfolder/cloudresumechallenge/dev-site
          pdf_count=$(find . -name "*.pdf" -type f | wc -l)
          
          if [ "$pdf_count" -eq 0 ]; then
            echo "‚ÑπÔ∏è  No PDF files found. Skipping upload."
            exit 0
          fi
          
          echo "üìÑ Uploading $pdf_count PDF file(s)..."
          find . -name "*.pdf" -type f | while IFS= read -r file; do
            echo "  Uploading: $file"
            aws s3 cp "$file" "s3://dev.theprojectfolder.com/${file#./}" \
              --content-type "application/pdf" \
              --cache-control "public, max-age=3600, must-revalidate"
          done

      # Catch any remaining files
      - name: Deploy Other Files
        run: |
          aws s3 sync ./theprojectfolder/cloudresumechallenge/dev-site/ s3://dev.theprojectfolder.com \
            --exclude "*.html" \
            --exclude "*.css" \
            --exclude "*.js" \
            --exclude "*.jpg" \
            --exclude "*.jpeg" \
            --exclude "*.png" \
            --exclude "*.gif" \
            --exclude "*.svg" \
            --exclude "*.webp" \
            --exclude "*.ico" \
            --exclude "*.woff*" \
            --exclude "*.ttf" \
            --exclude "*.eot" \
            --exclude "*.pdf"

      # Optional: Uncomment if using CloudFront
      # - name: Invalidate CloudFront Cache
      #   run: |
      #     aws cloudfront create-invalidation \
      #       --distribution-id YOUR_DISTRIBUTION_ID \
      #       --paths "/*"

      - name: Verify Deployment
        run: |
          echo "üîç Verifying deployment..."
          sleep 5  # Wait for S3 propagation
          
          response=$(curl -s -o /dev/null -w "%{http_code}" https://dev.theprojectfolder.com/index.html || echo "000")
          
          if [ "$response" = "200" ]; then
            echo "‚úÖ Deployment verified successfully (HTTP $response)"
          else
            echo "‚ö†Ô∏è  Warning: Deployment verification returned HTTP $response"
            echo "This might be normal if CloudFront is not yet configured."
          fi

      - name: Deployment Summary
        run: |
          echo "üöÄ Deployment Complete!"
          echo "Environment: Development"
          echo "S3 Bucket: s3://dev.theprojectfolder.com"
          echo "URL: https://dev.theprojectfolder.com"
          echo "Branch: ${{ github.ref_name }}"
          echo "Commit: ${{ github.sha }}"