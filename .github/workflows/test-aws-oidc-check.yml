name: ğŸ” Validate AWS OIDC Connection & Role Permissions
# Manual-only workflow to verify IAM trust policy, OIDC authentication,
# and AWS resource permissions for GitHubActionsProdRole before deployment.

on:
  workflow_dispatch:
    inputs:
      confirm:
        description: "Type 'yes' to confirm running the AWS OIDC & permissions test"
        required: true
        default: "yes"

jobs:
  sanity-test:
    name: Validate OIDC, S3, CloudFront, Route53, CloudFormation Access
    runs-on: ubuntu-latest

    # ğŸ§© REQUIRED for OIDC to work
    permissions:
      id-token: write        # allows the workflow to request an OIDC token
      contents: read         # allows reading the repo content if needed

    steps:
      - name: ğŸ§¾ Checkout Repository
        uses: actions/checkout@v3

      - name: ğŸ” Configure AWS Credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::102587257710:role/GitHubActionsProdRole
          aws-region: us-east-1

      - name: ğŸªª Verify AWS Identity
        run: aws sts get-caller-identity

      - name: ğŸ—‚ï¸ Check S3 Bucket Access
        run: |
          echo "Verifying access to all required S3 buckets..."
          aws s3 ls www.theprojectfolder.com || echo "âŒ Could not list main bucket"
          aws s3 ls theprojectfolder.com || echo "âš ï¸ Root redirect bucket read-only check"
          aws s3 ls my-site-access-logs || echo "âš ï¸ Access logs bucket read-only check"

      - name: ğŸ—ï¸ Verify CloudFormation Access
        run: |
          echo "Checking CloudFormation stack permissions..."
          aws cloudformation describe-stacks --stack-name frontend-stack-prod || echo "âŒ CloudFormation describe failed"

      - name: ğŸŒ Verify CloudFront Permissions
        run: |
          echo "Creating test invalidation to verify CloudFront access..."
          aws cloudfront create-invalidation \
            --distribution-id E2UA1URROHIZXT \
            --paths "/oidc-test-$(date +%s)" || echo "âŒ CloudFront invalidation failed"

      - name: ğŸŒ Verify Route53 Permissions
        run: |
          echo "Checking Route53 record listing permissions..."
          aws route53 list-resource-record-sets --hosted-zone-id Z03024793FWW1BZ4QAAUV | head -n 5 || echo "âŒ Route53 list failed"

      - name: âœ… Summary
        run: echo "OIDC Role and Permission validation complete."
